name: Deploy Client & Server Separately

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Check what files changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      client: ${{ steps.changes.outputs.client }}
      server: ${{ steps.changes.outputs.server }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          client:
            - 'client/**'
          server:
            - 'server/**'

  # Deploy client to cPanel
  deploy-client:
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install and build client
      working-directory: ./client
      run: |
        npm ci
        npm run build

    - name: Deploy Frontend to cPanel
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./client/dist/
        server-dir: /home/shilfmfe/public_html/admin.shilpgroup.com/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**

    - name: Client Deployment Summary
      run: |
        echo "âœ… Client deployed successfully!"
        echo "ğŸŒ URL: https://admin.shilpgroup.com"

  # Deploy server to Railway (or other platform)
  deploy-server:
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: server/package-lock.json

    - name: Install server dependencies
      working-directory: ./server
      run: npm ci --omit=dev

    - name: Deploy to Railway
      uses: railway-deploy/cli@v1
      with:
        service: ${{ secrets.RAILWAY_SERVICE }}
        token: ${{ secrets.RAILWAY_TOKEN }}
        path: ./server

    - name: Server Deployment Summary
      run: |
        echo "âœ… Server deployed successfully!"
        echo "ğŸš€ API: ${{ secrets.RAILWAY_URL }}/api/health"

  # Full deployment notification
  notify-completion:
    needs: [deploy-client, deploy-server]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Deployment Complete
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸ“± Frontend: https://admin.shilpgroup.com"
        echo "ğŸš€ Backend: Check Railway dashboard"
        echo "ğŸ” Login: shilpgroup47@gmail.com"